<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiberUtils Unit Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
        }
        h1 { color: #1e293b; }
        .test-suite { margin: 1.5rem 0; }
        .test-suite h2 {
            color: #475569;
            font-size: 1.1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .test {
            padding: 0.5rem 1rem;
            margin: 0.25rem 0;
            border-radius: 4px;
        }
        .test.pass { background: #d1fae5; color: #065f46; }
        .test.fail { background: #fee2e2; color: #991b1b; }
        .summary {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
        }
        .summary.all-pass { background: #d1fae5; color: #065f46; }
        .summary.has-fail { background: #fee2e2; color: #991b1b; }
        .error-detail {
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <h1>FiberUtils Unit Tests</h1>
    <div id="results"></div>
    <div id="summary"></div>

    <!-- Load the data module (contains FiberUtils) -->
    <script src="../js/data.js"></script>

    <script>
        // Simple test runner
        const results = [];

        function test(name, fn) {
            try {
                fn();
                results.push({ name, pass: true });
            } catch (e) {
                results.push({ name, pass: false, error: e.message });
            }
        }

        function assertEqual(actual, expected, msg) {
            if (actual !== expected) {
                throw new Error(`${msg || 'Assertion failed'}: expected "${expected}", got "${actual}"`);
            }
        }

        function assertTrue(value, msg) {
            if (!value) {
                throw new Error(msg || 'Expected true');
            }
        }

        function assertFalse(value, msg) {
            if (value) {
                throw new Error(msg || 'Expected false');
            }
        }

        // ============================================
        // formatNumber tests
        // ============================================
        const suite1 = 'formatNumber';

        test(`${suite1}: formats positive integers`, () => {
            assertEqual(FiberUtils.formatNumber(1234567), '1,234,567');
        });

        test(`${suite1}: formats zero`, () => {
            assertEqual(FiberUtils.formatNumber(0), '0');
        });

        test(`${suite1}: formats decimals`, () => {
            const result = FiberUtils.formatNumber(1234.56);
            assertTrue(result.includes('1,234'), 'Should format thousands');
        });

        test(`${suite1}: returns N/A for null`, () => {
            assertEqual(FiberUtils.formatNumber(null), 'N/A');
        });

        test(`${suite1}: returns N/A for undefined`, () => {
            assertEqual(FiberUtils.formatNumber(undefined), 'N/A');
        });

        test(`${suite1}: returns N/A for NaN`, () => {
            assertEqual(FiberUtils.formatNumber(NaN), 'N/A');
        });

        test(`${suite1}: returns N/A for Infinity`, () => {
            assertEqual(FiberUtils.formatNumber(Infinity), 'N/A');
        });

        // ============================================
        // formatCurrency tests
        // ============================================
        const suite2 = 'formatCurrency';

        test(`${suite2}: formats with dollar sign`, () => {
            const result = FiberUtils.formatCurrency(75000);
            assertTrue(result.startsWith('$'), 'Should start with $');
            assertTrue(result.includes('75,000'), 'Should format number');
        });

        test(`${suite2}: returns N/A for null`, () => {
            assertEqual(FiberUtils.formatCurrency(null), 'N/A');
        });

        test(`${suite2}: returns N/A for undefined`, () => {
            assertEqual(FiberUtils.formatCurrency(undefined), 'N/A');
        });

        // ============================================
        // formatPercent tests
        // ============================================
        const suite3 = 'formatPercent';

        test(`${suite3}: converts decimal to percent`, () => {
            assertEqual(FiberUtils.formatPercent(0.5), '50.0%');
        });

        test(`${suite3}: handles 0`, () => {
            assertEqual(FiberUtils.formatPercent(0), '0.0%');
        });

        test(`${suite3}: handles 1 (100%)`, () => {
            assertEqual(FiberUtils.formatPercent(1), '100.0%');
        });

        test(`${suite3}: respects decimal places parameter`, () => {
            assertEqual(FiberUtils.formatPercent(0.5678, 2), '56.78%');
        });

        test(`${suite3}: returns N/A for null`, () => {
            assertEqual(FiberUtils.formatPercent(null), 'N/A');
        });

        // ============================================
        // formatPercentDirect tests
        // ============================================
        const suite4 = 'formatPercentDirect';

        test(`${suite4}: formats number directly as percent`, () => {
            assertEqual(FiberUtils.formatPercentDirect(50), '50.0%');
        });

        test(`${suite4}: handles decimals`, () => {
            assertEqual(FiberUtils.formatPercentDirect(33.333, 2), '33.33%');
        });

        test(`${suite4}: returns N/A for null`, () => {
            assertEqual(FiberUtils.formatPercentDirect(null), 'N/A');
        });

        // ============================================
        // sanitizeString tests
        // ============================================
        const suite5 = 'sanitizeString';

        test(`${suite5}: returns string unchanged`, () => {
            assertEqual(FiberUtils.sanitizeString('hello'), 'hello');
        });

        test(`${suite5}: converts number to string`, () => {
            assertEqual(FiberUtils.sanitizeString(123), '123');
        });

        test(`${suite5}: returns empty string for null`, () => {
            assertEqual(FiberUtils.sanitizeString(null), '');
        });

        test(`${suite5}: returns empty string for undefined`, () => {
            assertEqual(FiberUtils.sanitizeString(undefined), '');
        });

        // ============================================
        // isValidFips tests
        // ============================================
        const suite6 = 'isValidFips';

        test(`${suite6}: validates 2-digit state FIPS`, () => {
            assertTrue(FiberUtils.isValidFips('36'), '36 should be valid state FIPS');
        });

        test(`${suite6}: validates 5-digit county FIPS`, () => {
            assertTrue(FiberUtils.isValidFips('36001'), '36001 should be valid county FIPS');
        });

        test(`${suite6}: accepts numeric input`, () => {
            assertTrue(FiberUtils.isValidFips(36), 'Numeric 36 should be valid');
        });

        test(`${suite6}: rejects 3-digit codes`, () => {
            assertFalse(FiberUtils.isValidFips('123'), '3 digits should be invalid');
        });

        test(`${suite6}: rejects 4-digit codes`, () => {
            assertFalse(FiberUtils.isValidFips('1234'), '4 digits should be invalid');
        });

        test(`${suite6}: rejects non-numeric strings`, () => {
            assertFalse(FiberUtils.isValidFips('AB'), 'Letters should be invalid');
        });

        test(`${suite6}: rejects null`, () => {
            assertFalse(FiberUtils.isValidFips(null), 'null should be invalid');
        });

        test(`${suite6}: rejects undefined`, () => {
            assertFalse(FiberUtils.isValidFips(undefined), 'undefined should be invalid');
        });

        // ============================================
        // calculatePenetration tests
        // ============================================
        const suite7 = 'calculatePenetration';

        test(`${suite7}: calculates correct ratio`, () => {
            assertEqual(FiberUtils.calculatePenetration(50, 100), 0.5);
        });

        test(`${suite7}: returns 0 for divide by zero`, () => {
            assertEqual(FiberUtils.calculatePenetration(50, 0), 0);
        });

        test(`${suite7}: caps at 1 (100%)`, () => {
            assertEqual(FiberUtils.calculatePenetration(150, 100), 1);
        });

        test(`${suite7}: returns 0 for negative served`, () => {
            const result = FiberUtils.calculatePenetration(-50, 100);
            assertEqual(result, 0);
        });

        test(`${suite7}: handles NaN input`, () => {
            assertEqual(FiberUtils.calculatePenetration(NaN, 100), 0);
        });

        // ============================================
        // ColorScales tests
        // ============================================
        const suite8 = 'ColorScales';

        test(`${suite8}: returns color for valid penetration value`, () => {
            const color = ColorScales.getColor('penetration', 0.25);
            assertTrue(color.startsWith('#'), 'Should return hex color');
        });

        test(`${suite8}: returns fallback for invalid value`, () => {
            const color = ColorScales.getColor('penetration', NaN);
            assertEqual(color, '#cbd5e1', 'Should return fallback gray');
        });

        test(`${suite8}: returns fallback for invalid layer`, () => {
            const color = ColorScales.getColor('nonexistent', 0.5);
            assertEqual(color, '#cbd5e1', 'Should return fallback gray');
        });

        test(`${suite8}: getLegend returns array for valid layer`, () => {
            const legend = ColorScales.getLegend('penetration');
            assertTrue(Array.isArray(legend), 'Should return array');
            assertTrue(legend.length > 0, 'Should have items');
        });

        // ============================================
        // NYC_BOROUGHS tests
        // ============================================
        const suite9 = 'NYC_BOROUGHS';

        test(`${suite9}: contains Bronx FIPS`, () => {
            assertTrue(NYC_BOROUGHS.has('36005'), 'Should contain Bronx');
        });

        test(`${suite9}: contains Kings (Brooklyn) FIPS`, () => {
            assertTrue(NYC_BOROUGHS.has('36047'), 'Should contain Brooklyn');
        });

        test(`${suite9}: contains New York (Manhattan) FIPS`, () => {
            assertTrue(NYC_BOROUGHS.has('36061'), 'Should contain Manhattan');
        });

        test(`${suite9}: contains Queens FIPS`, () => {
            assertTrue(NYC_BOROUGHS.has('36081'), 'Should contain Queens');
        });

        test(`${suite9}: contains Richmond (Staten Island) FIPS`, () => {
            assertTrue(NYC_BOROUGHS.has('36085'), 'Should contain Staten Island');
        });

        test(`${suite9}: does not contain Albany`, () => {
            assertFalse(NYC_BOROUGHS.has('36001'), 'Should not contain Albany');
        });

        test(`${suite9}: is frozen (immutable)`, () => {
            assertTrue(Object.isFrozen(NYC_BOROUGHS), 'Should be frozen');
        });

        // ============================================
        // Render results
        // ============================================
        const resultsDiv = document.getElementById('results');
        const summaryDiv = document.getElementById('summary');

        // Group by suite
        const suites = {};
        results.forEach(r => {
            const [suite] = r.name.split(':');
            if (!suites[suite]) suites[suite] = [];
            suites[suite].push(r);
        });

        // Render
        for (const [suiteName, tests] of Object.entries(suites)) {
            const suiteDiv = document.createElement('div');
            suiteDiv.className = 'test-suite';
            suiteDiv.innerHTML = `<h2>${suiteName}</h2>`;

            tests.forEach(t => {
                const testDiv = document.createElement('div');
                testDiv.className = `test ${t.pass ? 'pass' : 'fail'}`;
                testDiv.textContent = `${t.pass ? '✓' : '✗'} ${t.name.split(': ')[1] || t.name}`;
                if (t.error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-detail';
                    errorDiv.textContent = t.error;
                    testDiv.appendChild(errorDiv);
                }
                suiteDiv.appendChild(testDiv);
            });

            resultsDiv.appendChild(suiteDiv);
        }

        // Summary
        const passed = results.filter(r => r.pass).length;
        const failed = results.filter(r => !r.pass).length;
        const total = results.length;

        summaryDiv.className = `summary ${failed === 0 ? 'all-pass' : 'has-fail'}`;
        summaryDiv.textContent = `${passed}/${total} tests passed` + (failed > 0 ? `, ${failed} failed` : '');
    </script>
</body>
</html>
